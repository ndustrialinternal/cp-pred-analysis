<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Predictions vs. Actual Peaks</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f9f9f9; color: #333; }
    h1, h2 { margin-bottom: 0.5rem; }
    section { margin-top: 2rem; padding: 1rem; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin: .5rem 0 1.5rem; }
    th, td { padding: .5rem; border: 1px solid #ccc; text-align: center; }
    th { background: #f0f0f0; }
    #loading { font-style: italic; color: #666; }
    .error { color: #c00; margin-top: .5rem; }
  </style>
</head>
<body>
  <h1>Amperon Day‑0 Predictions vs. Actual Daily Peaks</h1>
  <div id="loading">Loading data…</div>
  <div id="error" class="error" style="display:none;"></div>
  <div id="content" style="display:none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
  (async () => {
    try {
      const SUPABASE_URL = 'https://univbemvihlcincvqwpz.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuaXZiZW12aWhsY2luY3Zxd3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5NjM1MzYsImV4cCI6MjA2NjUzOTUzNn0.qLq66dTzf_ATHfBDKyRU5PIwKX5Sj0-2yP-1ceFFAzM';
      const GRIDSTATUS_KEY = 'bda3a30f30804e22a62e4637700bab54';

      // <-- rename client variable so we don't shadow the global -->
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const sources = [
        { table: 'peak_snapshots_pjm_5cp_plc',       label: 'PJM RTO', type: 'pjm', apiKey: 'load.pjm_rto' },
        /* ... other PJM zones ... */
        { table: 'peak_snapshots_ercot_4cp',         label: 'ERCOT',  type: 'ercot' }
      ];

      async function fetchPredictions(table) {
        const { data, error } = await supabaseClient
          .from(table)
          .select('captured_at, day_0_peak_hour, day_0_peak_load')
          .order('captured_at', { ascending: true });
        if (error) throw error;
        return data.filter(r => r.captured_at.includes('T08:'));
      }

      const allPreds = {};
      await Promise.all(sources.map(async s => {
        allPreds[s.table] = await fetchPredictions(s.table);
      }));

      const content = document.getElementById('content');
      for (const src of sources) {
        const preds = allPreds[src.table];
        if (!preds.length) continue;

        const sec = document.createElement('section');
        sec.innerHTML = `<h2>${src.label}</h2>
          <table>
            <thead><tr>
              <th>Predicted Peak Time</th>
              <th>Predicted Load (MW)</th>
              <th>Actual Peak Time</th>
              <th>Actual Peak (MW)</th>
            </tr></thead><tbody></tbody>
          </table>`;
        const tbody = sec.querySelector('tbody');

        for (const row of preds) {
          const datePart = row.captured_at.split('T')[0];
          let ph = row.day_0_peak_hour;
          const ampm = ph >= 12 ? 'PM' : 'AM';
          const h12 = ph % 12 || 12;
          const tz = src.type === 'pjm' ? 'ET' : 'CT';
          const predictedTime = `${String(h12).padStart(2,'0')}:00 ${ampm} ${tz}`;

          // fetch actual…
          let actualVal = 0, actualTime = '';
          if (src.type === 'pjm') {
            const resp = await fetch(
              `https://api.gridstatus.io/v1/datasets/pjm_standardized_hourly/query` +
              `?start_time=${datePart}T12:00:00&end_time=${datePart}T21:00:00&timezone=market`,
              { headers: { 'x-api-key': GRIDSTATUS_KEY } }
            );
            const arr = (await resp.json()).data || [];
            let max = arr[0] || {};
            arr.forEach(e => { if ((e[src.apiKey]||0) > (max[src.apiKey]||0)) max = e; });
            actualVal = max[src.apiKey]||0;
            if (max.interval_end_local) {
              actualTime = new Date(max.interval_end_local)
                .toLocaleTimeString('en-US',{timeZone:'America/New_York',hour12:true,hour:'2-digit',minute:'2-digit'});
            }
          } else {
            const resp = await fetch(
              `https://api.gridstatus.io/v1/datasets/ercot_estimated_coincident_peak_load/query` +
              `?start_time=${datePart}T12:00:00&end_time=${datePart}T21:00:00&timezone=market`,
              { headers: { 'x-api-key': GRIDSTATUS_KEY } }
            );
            const arr = ((await resp.json()).data || []).map(d => ({
              ...d,
              cp: d.internal_generation + d.dc_tie_imports - d.dc_tie_exports - d.wholesale_storage_load
            }));
            let max = arr[0] || {};
            arr.forEach(d => { if ((d.cp||0) > (max.cp||0)) max = d; });
            actualVal = max.cp||0;
            if (max.interval_end_local) {
              actualTime = new Date(max.interval_end_local)
                .toLocaleTimeString('en-US',{timeZone:'America/Chicago',hour12:true,hour:'2-digit',minute:'2-digit'});
            }
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${predictedTime}</td>
            <td>${Number(row.day_0_peak_load).toLocaleString(undefined,{minimumFractionDigits:3,maximumFractionDigits:3})}</td>
            <td>${actualTime}</td>
            <td>${actualVal.toLocaleString(undefined,{minimumFractionDigits:3,maximumFractionDigits:3})}</td>`;
          tbody.appendChild(tr);
        }

        content.appendChild(sec);
      }

      document.getElementById('loading').style.display = 'none';
      content.style.display = '';
    } catch (err) {
      document.getElementById('loading').style.display = 'none';
      const eDiv = document.getElementById('error');
      eDiv.innerText = 'Error: ' + err.message;
      eDiv.style.display = '';
    }
  })();
  </script>
</body>
</html>
